---
title: "Data Generating Mechanism"
author: "Alex Carriero"
output: html_document
---
```{r}
# Note:

# add noise the number of people selected in each group so ev is not the same every time 

# What we can vary: 

# predictor means within groups        --- no
# predictor means between groups       --- yes

# predictor variance within groups     --- no 
# predictor variance between groups    --- yes

# predictor covariance within groups   ---  no
# predictor covariance between groups  ---  no
```

# Functions, Libraries
```{r, warning = F, message = F}
library(tidyverse)
library(MASS)
library(pROC)
library(tableone)
```

```{r}
scenario <- function(npred, dmu = 0.5, dsig = 0.1){

x <- dmu                      # mean difference between classes 
y <- dsig                     # var  difference between classes 
z <- 0.2                      # cov  among predictors 
p <- 0.8                      # proportion of correlated predictors

# number of predictors
npred <-  npred 

# set up correlations
corr  <-  matrix(0, npred, npred)      # matrix: cov matrix, 0 on diagonals
corr[1:npred*p, 1:npred*p] = z
diag(corr) = 0

# mean structures
mu0    <-  c(rep(0,npred))             # vector: class 0 means
dmu    <-  c(rep(x,npred))             # vector: difference in means between classes 
mu1    <-  mu0 + dmu                   # vector: class 1 means 

# covariance structures
sigma0 <-  diag(npred)   + corr        # matrix: cov matrix of class 0 
dsig   <-  diag(c(rep(y, npred)))      # matrix: difference in cov matrix between classes 
sigma1 <-  sigma0 - dsig               # matrix: cov matrix of class 1

return(list(npred, mu0, mu1, sigma0, sigma1))
}
```

```{r}
scenario(npred = 10)
```

```{r}
generate_data <- function(inn, ev = 0.2, n.level = 1){
  
  npred  = inn[[1]]
  mu0    = inn[[2]]
  mu1    = inn[[3]]
  sigma0 = inn[[4]]
  sigma1 = inn[[5]]
  
  # calculate sample size   
  n =  exp((-0.508 + 0.259*log(1-ev) + 0.504*log(npred) - log(0.050))/0.544)
  n =  ceiling(n*n.level)
  
  # positive class
  n1      <- ceiling(ev*n)
  class_1 <- mvrnorm(n1, mu1, sigma1)

  # negative class
  n0      <- ceiling((1-ev)*n)
  class_0 <- mvrnorm(n0, mu0, sigma0)

  outcome <- c(rep(1, n1), rep(0, n0))

  # format data frame
  df <- cbind(rbind(class_1, class_0), outcome)%>% 
        as.data.frame() %>% 
        mutate(outcome = as.factor(outcome))
  
  return(df)
}
```


```{r, warning = F, message = F}
# view summary statistics
summ <- function(df){
  a <- CreateTableOne(data = df, strat = "outcome")
  return(a)
}
```

```{r, warning = F, message = F}
# visualization
visualize <- function(df){
  df <- df 
  df %>%
  arrange(outcome)%>%
  ggplot(aes(x = V1, y = V2, col = outcome)) + 
  geom_point(alpha = 0.7) + 
  theme_minimal() + 
  ggtitle("Simulated Data:") + 
  scale_color_manual("Class", values = c("goldenrod1", "darkblue")) + 
  xlab("Predictor 1") +
  ylab("Predictor 2")
}
```

```{r}
# discrimination 
get_auc <- function(df){
  
mod  <- glm(outcome~., family = "binomial", data = df)
pred <- predict(mod, type="response")
auc  <- auc(df$outcome, pred)

return(auc)
}
```

# One example
```{r}
# generate data
df <- generate_data(scenario(npred = 16), ev = 0.02)
df
```

```{r}
# all together
summ(df) 
get_auc(df)
visualize(df)
```

# Get Parameter Values

```{r, message = F}
# simulation to determine mean and variance values: get appropriate auc 
set.seed(911)
auc <- c()

for (i in 1:2000){                                          
  df      <- generate_data(scenario(npred = 16, dmu = 0.44, dsig = 0.2), ev = 0.02)
  auc[i]  <- get_auc(df)
}

mean(auc)   
sd(auc)     
```

```{r}
delta_mu1  <- c()
delta_sig1 <- c()
delta_mu2  <- c(0.62, 0.62, 0.56, 0.50, 0.50, 0.44)
delta_sig2 <- c(0.20, 0.20, 0.20, 0.20, 0.20, 0.20)
auc2 <- c(0.851, 0.851, 0.850, 0.852, 0.852, 0.851)
sd2  <- c(0.017, 0.019, 0.047, 0.013, 0.014, 0.034)
```

```{r}
# store success values in a table
ef <- c(0.5, 0.2, 0.02)
p  <- c(8, 16, 28)
n  <- c("0.5N", "N", "2N")

delta_mu  <- c(rep(NA, 27))
delta_sig <- c(rep(NA, 27))

grid <- expand.grid(ef, p, n)
grid <- 
  as.data.frame(grid) %>% 
  mutate(dmu  = delta_mu,
         dsig = delta_sig, 
         auc  = c(rep(NA, 27)),
         sd   = c(rep(NA, 27))) %>% 
    rename("ef"    = Var1, 
           "npred" = Var2, 
           "n"     = Var3) 
grid
```

